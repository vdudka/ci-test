apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: demo-task
spec:
  resources:
    inputs:
      - name: demo-repo
        type: git

  steps:
  - name: create-config
    image: busybox
    workingDir: /workspace
    script: |
      #!/bin/sh
      echo "Create docker config file with Farbor admin account"
      mkdir -p /workspace/.docker/
      echo '{"auths": {"harbor-core.kube-system.svc.cluster.local":{"auth": "YWRtaW5AaGFyYm9yLmxvY2FsOkhhcmJvcjEyMzQ1"}}}' > /workspace/.docker/config.json
      echo "docker config:"
      cat /workspace/.docker/config.json
      ls -la -R demo-repo/

  - name: build-and-push
    workingDir: /kaniko/
    image: gcr.io/kaniko-project/executor:v1.7.0
    env:
      - name: DOCKER_CONFIG
        value: /workspace/.docker
    command:
      - /kaniko/executor
      - --dockerfile=demo-repo/Dockerfile
      - --context=/workspace
      - --skip-tls-verify-pull
      - --skip-tls-verify
      - --destination=harbor-core.kube-system.svc.cluster.local/ci/tekton-test:v2
